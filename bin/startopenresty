#!/usr/bin/env bash
set -euo pipefail

SOURCE_CONF="$1"
DEST_CONF=/usr/local/openresty/nginx/conf/nginx.conf
TEST_CONF="$(mktemp --tmpdir=/usr/local/openresty/nginx/conf --suffix=-nginx.conf.test)"

cat <<- EOF | python - "$SOURCE_CONF" > "$TEST_CONF"
import sys
from os import environ
from jinja2 import Template

with open(sys.argv[1]) as f:
  template = Template(f.read())
  rendered = template.render(**environ)
  sys.stdout.write(rendered)
EOF

openresty -c "$TEST_CONF" -t || {
  cat "$TEST_CONF" >&2
  exit 1
}

mv "$TEST_CONF" "$DEST_CONF"
exec openresty
