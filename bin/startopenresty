#!/usr/bin/env bash
set -euo pipefail

OPENRESTY_DIR="$(pwd)/openresty"
OPENRESTY_BIN="$OPENRESTY_DIR/bin/openresty"
SOURCE_NGINX_CONF="$(pwd)/nginx.conf"
DEST_NGINX_CONF="$OPENRESTY_DIR/nginx/conf/nginx.conf"
TEST_NGINX_CONF="$(mktemp --tmpdir=$OPENRESTY_DIR/nginx/conf --suffix=-nginx.conf.test)"
LUA_APP_PATH="$(pwd)/app"

while getopts "a:c:" opt; do
  case "$opt" in
    c) SOURCE_NGINX_CONF="$OPTARG";;
    a) LUA_APP_PATH="$OPTARG";;
  esac
done

export LUA_APP_PATH

cat <<- EOF | python - "$SOURCE_NGINX_CONF" > "$TEST_NGINX_CONF"
import sys
from os import environ
from jinja2 import Template

with open(sys.argv[1]) as f:
  template = Template(f.read())
  rendered = template.render(**environ)
  sys.stdout.write(rendered)
EOF

"$OPENRESTY_BIN" -c "$TEST_NGINX_CONF" -t || {
  cat "$TEST_NGINX_CONF" >&2
  exit 1
}

mv "$TEST_NGINX_CONF" "$DEST_NGINX_CONF"
exec "$OPENRESTY_BIN"
