#!/usr/bin/env bash
set -euo pipefail

INSTALL_DIR="$(pwd)/openresty"
OPENRESTY_BIN=$INSTALL_DIR/bin/openresty
SOURCE_CONF="$1"
DEST_CONF=$INSTALL_DIR/nginx/conf/nginx.conf
TEST_CONF="$(mktemp --tmpdir=$INSTALL_DIR/nginx/conf --suffix=-nginx.conf.test)"

cat <<- EOF | python - "$SOURCE_CONF" > "$TEST_CONF"
import sys
from os import environ
from jinja2 import Template

with open(sys.argv[1]) as f:
  template = Template(f.read())
  rendered = template.render(**environ)
  sys.stdout.write(rendered)
EOF

$OPENRESTY_BIN -c "$TEST_CONF" -t || {
  cat "$TEST_CONF" >&2
  exit 1
}

mv "$TEST_CONF" "$DEST_CONF"
exec "$OPENRESTY_BIN"
