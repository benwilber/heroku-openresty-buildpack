#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
set -euo pipefail -x



BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
OPENRESTY_DIR="$BUILD_DIR/openresty"

export PATH="$PATH:$OPENRESTY_DIR/openresty/bin:$OPENRESTY_DIR/openresty/luajit/bin"
echo "$PATH"

echo_header() {
  echo "-----> OpenResty: $1"
}

echo_indented() {
  echo "       $1"
}

mkdir -p "$OPENRESTY_DIR"
tar -zxf "openresty-$STACK".tar.gz -C "$OPENRESTY_DIR"

echo_header "Installed $(cat $OPENRESTY_DIR/version.txt)"

if [[ -f "$BUILD_DIR/opm.txt" ]]; then
  echo_header "Installing OPM packages from opm.txt"

  xargs "$OPENRESTY_DIR/bin/opm" get < "$BUILD_DIR/opm.txt" 2>&1 | \
  while read line; do
    echo_indented "$line"
  done
fi
