#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
set -euo pipefail

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
OPENRESTY_DIR=/tmp/openresty
OPENRESTY_BIN="$OPENRESTY_DIR/bin/openresty"

mkdir "$OPENRESTY_DIR"
tar -zxvf "openresty-$STACK".tgz -C "$OPENRESTY_DIR"

nginx_version=$("OPENRESTY_BIN" -V 2>&1 | head -1 | awk '{print $NF}')
echo "-----> openresty: Installed ${nginx_version} to app/bin"
cp bin/startopenresty "$BUILD_DIR/bin"
chmod +x "$BUILD_DIR/bin/startopenresty"
echo "-----> openresty: Added startopenresty to app/bin"
