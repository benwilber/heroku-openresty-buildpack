#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR
set -euo pipefail

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

echo "-----> Installing OpenResty..."
tar -zxf "openresty-$STACK".tar.gz -C "$BUILD_DIR"
cp -a conf/nginx.conf.default "$BUILD_DIR/openresty/nginx/conf"
cp -a bin/startopenresty "$BUILD_DIR/openresty/bin"
fold -w 80 -s < "$BUILD_DIR/openresty/openresty-V.txt" | pr -to 7

mkdir -p "$BUILD_DIR/.profile.d"
cat << "EOF" > "$BUILD_DIR/.profile.d/000-openresty-path.sh"
export PATH="$PATH:$HOME/openresty/bin:$HOME/openresty/luarocks/bin:$HOME/openresty/luajit/bin:$HOME/openresty/nginx/sbin"
EOF
chmod +x "$BUILD_DIR/.profile.d/000-openresty-path.sh"

ln -s "$BUILD_DIR/openresty" /app/openresty

if [[ -f "$BUILD_DIR/opm.txt" ]]; then
  PATH="$PATH:/app/openresty/bin:/app/openresty/luarocks/bin:/app/openresty/luajit/bin:/app/openresty/nginx/sbin" \
    xargs opm get < "$BUILD_DIR/opm.txt"
fi

if [[ -f "$BUILD_DIR/luarocks.txt" ]]; then
  PATH="$PATH:/app/openresty/bin:/app/openresty/luarocks/bin:/app/openresty/luajit/bin:/app/openresty/nginx/sbin" \
    while read line; do
      luarocks install "$line"
    done < "$BUILD_DIR/luarocks.txt"
fi

rm -f /app/openresty
